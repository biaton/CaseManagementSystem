{% extends "official_portal/base_official.html" %}
{% block official_title %}Manage Lupon Schedule{% endblock %}

{% block extra_head_official %}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .form-input { display:block; width:100%; padding:.5rem .75rem; border:1px solid #d1d5db; border-radius:.375rem; }
    </style>
{% endblock %}

{% block official_content_main %}
<div class="bg-white p-6 rounded-lg shadow-md border"
     x-data="{ 
        isAddModalOpen: false, 
        isEditModalOpen: false, 
        isDeleteModalOpen: false,
        editActionUrl: '', editFullName: '', editPosition: '', editIsActive: false,
        deleteActionUrl: '', deleteIdentifier: '' 
     }">
    
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Lupon Tagapamayapa Schedule</h2>
        <button @click="isAddModalOpen = true" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ADD Name</button>
    </div>
    
    <form method="POST" action="{% url 'system_settings:manage_lupon_schedule' %}">
        {% csrf_token %}
        <div class="overflow-x-auto rounded-lg border">
            <table class="w-full text-sm border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-left border">Name</th>
                        <th class="p-3 text-center border">Monday</th>
                        <th class="p-3 text-center border">Tuesday</th>
                        <th class="p-3 text-center border">Wednesday</th>
                        <th class="p-3 text-center border">Thursday</th>
                        <th class="p-3 text-center border">Friday</th>
                        <th class="p-3 text-center border">Actions</th>
                    </tr>
                </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                    {% for member in lupon_members %}
                <tr class="border-b hover:bg-gray-50 {% if not member.is_active %}bg-red-50 text-gray-400 line-through{% endif %}">
                        <td class="p-3 font-semibold border-r">
                        {{ member.full_name }}
                        <p class="text-xs font-normal text-gray-500">{{ member.position }}</p>
                    </td>
        
                    <!-- ITO ANG PINAKASIMPLENG FOR LOOP -->
                    {% for is_avail in member.availability_list %}
                    <td class="text-center p-3 border-r">
                        <input type="checkbox" name="availability_{{ member.id }}_{{ forloop.counter0 }}" 
                             class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500" 
                            {% if is_avail %}checked{% endif %}>
                    </td>
                    {% endfor %}

                    <td class="text-center p-3 border-r space-x-2">
                        <button @click.prevent="isEditModalOpen = true; editActionUrl=`{% url 'system_settings:edit_lupon_member' member.pk %}`; editFullName=`{{ member.full_name|escapejs }}`; editPosition=`{{ member.position|escapejs }}`; editIsActive={{ member.is_active|yesno:'true,false' }};" type="button" class="text-indigo-600"><i class="bi bi-pencil-fill"></i></button>
                        <button @click.prevent="isDeleteModalOpen = true; deleteActionUrl=`{% url 'system_settings:delete_lupon_member' member.pk %}`; deleteIdentifier=`{{ member.full_name|escapejs }}`;" type="button" class="text-red-600"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="p-6 text-center text-gray-500">No Lupon members added yet.</td></tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
        <div class="mt-6 flex justify-end gap-4">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Update</button>
            <!--<a href="{% url 'official_dashboard' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Back or Close</a>-->
        </div>
    </form>

    <!-- ADD MODAL -->
    <!-- ADD MODAL WITH BACKDROP AND FOCUS TRAP -->
    <div 
        x-show="isAddModalOpen" 
        x-transition 
        x-trap="isAddModalOpen"
        class="fixed inset-0 z-50 flex items-center justify-center"
        style="display: none;"
        aria-modal="true"
        role="dialog"
    >
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black bg-opacity-50" @click="isAddModalOpen = false"></div>
        <!-- Modal Content -->
        <div class="bg-white rounded-lg shadow-lg z-10 p-6 w-full max-w-md relative">
            <button @click="isAddModalOpen = false" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl" aria-label="Close">&times;</button>
            <form method="POST" action="{% url 'system_settings:add_lupon_member' %}">
                {% csrf_token %}
                {{ add_form.as_p }}
                <div class="mt-4 flex justify-end gap-2">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add Member</button>
                    <button type="button" @click="isAddModalOpen = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    <div x-show="isEditModalOpen" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display:none;">
    <!-- Overlay -->
    <div @click="isEditModalOpen=false" class="fixed inset-0 bg-black bg-opacity-50"></div>
    
    <!-- Modal Content -->
    <div @click.outside="isEditModalOpen=false" class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden transform transition-all">
        <form :action="editActionUrl" method="POST">
            {% csrf_token %}
            <!-- Modal Header -->
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900">Edit Lupon Member</h3>
                <p class="text-sm text-gray-500">Update the details for <strong x-text="editFullName"></strong>.</p>
                
                <!-- Form Fields -->
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="edit-full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="edit-full-name" name="full_name" x-model="editFullName" class="form-input mt-1">
                    </div>
                    <div>
                        <label for="edit-position" class="block text-sm font-medium text-gray-700">Position</label>
                        <input type="text" id="edit-position" name="position" x-model="editPosition" class="form-input mt-1">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="is_active" :checked="editIsActive" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700">Active Member</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                <button @click="isEditModalOpen=false" type="button" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-success">Update Member</button>
            </div>
        </form>
    </div>
</div>
    <!-- DELETE MEMBER MODAL -->
<div x-show="isDeleteModalOpen" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
    <!-- Overlay -->
    <div @click="isDeleteModalOpen = false" class="fixed inset-0 bg-black bg-opacity-60"></div>
    
    <!-- Modal Content -->
    <div @click.outside="isDeleteModalOpen = false" class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden transform transition-all">
        <form :action="deleteActionUrl" method="POST">
            {% csrf_token %}
            <!-- Modal Body -->
            <div class="p-6 text-center">
                <div class="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="mt-4 text-lg font-semibold text-gray-900">Delete Member</h3>
                <p class="mt-2 text-sm text-gray-500">Are you sure you want to delete <strong x-text="deleteIdentifier"></strong>? This action cannot be undone.</p>
            </div>
            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                <button @click="isDeleteModalOpen=false" type="button" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-danger">Yes, Delete</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}