{% extends "official_portal/base_official.html" %}
{% load report_extras %} <!-- I-load ang custom filter na ginawa natin -->

{% block official_title %}Monthly Report by Incident Type{% endblock %}

{% block extra_head_official %}
<style>
    @page { size: landscape; margin: 0.5in; }
    @media print {
        body * { visibility: hidden; }
        #printable-area, #printable-area * { visibility: visible; }
        #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
        .no-print { display: none !important; }
    }
    .report-table { width: 100%; border-collapse: collapse; font-size: 10px; }
    .report-table th, .report-table td { border: 1px solid #333; padding: 3px 5px; text-align: center; }
    .report-table thead th { background-color: #f2f2f2; font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; white-space: nowrap; padding: 8px 4px; }
    .header-main { writing-mode: horizontal-tb !important; vertical-align: middle; }
    .total-row td { font-weight: bold; background-color: #e0e0e0; }
</style>
{% endblock %}

{% block official_content_main %}
<div class="bg-white p-6 rounded-lg shadow-md border">
    <div class="flex justify-between items-center mb-4 no-print">
        <h2 class="text-xl font-bold">MONTHLY REPORT BY INCIDENT TYPE</h2>
        <div class="flex items-center gap-4">
            <form method="GET">
                <select name="year" onchange="this.form.submit()" class="py-2 pl-3 pr-8 border rounded-md text-sm">
                    {% for year_option in years %}
                        <option value="{{ year_option }}" {% if year_option == selected_year %}selected{% endif %}>{{ year_option }}</option>
                    {% endfor %}
                </select>
            </form>
            <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="bi bi-printer-fill mr-2"></i>Print Report</button>
        </div>
    </div>

    <div id="printable-area" class="overflow-x-auto">
        <h2 class="text-xl font-bold text-center mb-4 hidden print:block">MONTHLY REPORT BY INCIDENT TYPE ({{ selected_year }})</h2>
        <table class="report-table">
            <thead>
                <tr>
                    <th class="header-main">Month</th>
                    {% for key, name in incident_types %}
                        <th>{{ name }}</th>
                    {% endfor %}
                    <th class="header-main">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                <!-- Monthly Data -->
                {% for month_num, data in monthly_data.items %}
                <tr>
                    <td class="font-bold text-left px-2">{{ month_names|get:month_num }}</td>
                    {% for key, name in incident_types %}
                        <td>{{ data|get:key|default:0 }}</td>
                    {% endfor %}
                    <td class="font-bold">{{ data.total }}</td>
                </tr>
                {% endfor %}
                
                <!-- Quarterly Totals -->
                {% for q_num, data in quarters.items %}
                <tr class="total-row">
                    <td>Total for Q{{ q_num }}</td>
                    {% for key, name in incident_types %}
                        <td>{{ data|get:key|default:0 }}</td>
                    {% endfor %}
                    <td>{{ data.total }}</td>
                </tr>
                {% endfor %}

                <!-- Annual Total -->
                <tr class="total-row">
                    <td>TOTAL ANNUAL</td>
                    {% for key, name in incident_types %}
                        <td>{{ totals|get:key|default:0 }}</td>
                    {% endfor %}
                    <td>{{ totals.total }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}