{% extends "resident_portal/base_resident.html" %}
{% load static %}
{% block title %}Create a Report{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS (para sa mapa) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        width: 100%;
        border-radius: 0.5rem;
        border: 1px solid #ccc;
    }

    .form-input-style {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #D1D5DB;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .form-input-style:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        border-color: #2563EB;
        box-shadow: 0 0 0 2px #BFDBFE;
    }
</style>
{% endblock extra_head %}

{% block content %}
<form method="POST" enctype="multipart/form-data" class="bg-white p-6 md:p-8 rounded-lg shadow-md">
    {% csrf_token %}
    <h1 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">Create a New Report</h1>

    <div class="space-y-8">
        <!-- Complainant Details -->
        <fieldset><legend class="text-lg font-semibold">Informant's Details</legend>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm">First Name*</label>{{ form.complainant_first_name }}</div>
                    <div><label class="block text-sm">Last Name*</label>{{ form.complainant_last_name }}</div>
                    <div><label class="block text-sm">Middle Name</label>{{ form.complainant_middle_name }}</div>
                    <div><label class="block text-sm">Suffix</label>{{ form.complainant_suffix }}</div>
                    <div class="md:col-span-2"><label class="block text-sm">Address*</label>{{ form.complainant_address }}</div>
                    <div class="md:col-span-2"><label class="block text-sm">Contact Number*</label>{{ form.informant_contact_number }}</div>
                </div>
            </fieldset>

        <!-- Report Details -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700">Report Details (Detalye ng Ulat)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div>
                    <label for="{{ form.date_of_incident.id_for_label }}"
                        class="block text-sm font-medium text-gray-700 mb-1">Petsa ng Pangyayari <span
                            class="text-red-500">*</span></label>
                    {{ form.date_of_incident }}
                </div>
            </div>
            <div class="mt-6">
                <label for="{{ form.report_details.id_for_label }}"
                    class="block text-sm font-medium text-gray-700 mb-1">Buong Detalye ng Ulat <span
                        class="text-red-500">*</span></label>
                {{ form.report_details }}
            </div>
        </div>

        <!-- Map Section -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700">Your Location (Ang Iyong Lokasyon)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 items-end">
                <!-- Location Search Input -->
                <div class="md:col-span-2">
                    <label for="locationSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Address /
                        Place Name (Mag-search o i-type ang address)</label>
                    <input type="text" id="locationSearchInput" name="location_of_incident" class="form-input-style"
                        placeholder="Search location...">
                    <!-- NOTE: Pinalitan natin ang {{ form.location_of_incident }} ng manual <input> para sa mas magandang control sa JavaScript -->
                </div>
                <!-- Current Location Button -->
                <button type="button" id="currentLocationBtn"
                    class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex items-center justify-center">
                    <i class="bi bi-geo-alt-fill mr-2"></i>Gamitin ang Lokasyon
                </button>
            </div>
            <div id="map" class="mt-4"></div>
            <!-- Hidden lat/long fields from the form -->
            {{ form.latitude }}
            {{ form.longitude }}
        </div>

        <div class="mt-8 border-t pt-6 flex justify-end">
            <a href="{% url 'resident_portal:dashboard' %}"
                class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md mr-4 hover:bg-gray-300">Cancel</a>
            <button type="submit"
                class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">Submit
                Report</button>
        </div>
</form>
{% endblock content %}

{% block extra_scripts %}
<!-- Leaflet JS (para sa mapa) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initial map setup (e.g., center sa Metro Manila)
        const map = L.map('map').setView([14.5995, 120.9842], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let marker;

        function updateLocation(lat, lng, updateAddressField = true) {
            // Update marker
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 16);

            // Update hidden form fields
            document.getElementById('id_latitude').value = lat.toFixed(6);
            document.getElementById('id_longitude').value = lng.toFixed(6);

            // Optional: Reverse geocoding to get address from lat/lng
            if (updateAddressField) {
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.display_name) {
                            document.getElementById('locationSearchInput').value = data.display_name;
                        }
                    });
            }
        }

        // Button for current location
        document.getElementById('currentLocationBtn').addEventListener('click', function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    updateLocation(lat, lng);
                }, function () {
                    alert('Error: The Geolocation service failed.');
                });
            } else {
                alert("Error: Your browser doesn't support geolocation.");
            }
        });

        // Map click event
        map.on('click', function (e) {
            updateLocation(e.latlng.lat, e.latlng.lng);
        });

        // TODO: Search functionality (requires more advanced setup, maybe with a geocoding service)
    });
</script>
{% endblock extra_scripts %}