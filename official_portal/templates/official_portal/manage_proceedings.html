{% extends "official_portal/base_official.html" %}
{% load static %}

{% block official_title %}Proceedings for {{ case.blotter_id }}{% endblock %}

{% block extra_head_official %}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .schedule-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.5rem; border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; }
        .schedule-item:hover { background-color: #f9fafb; }
        .schedule-item:last-child { border-bottom: none; }
        .form-input, .form-select { width: 100%; padding: 0.65rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* WALA NANG @media print DITO */
    </style>
{% endblock %}

{% block official_content_main %}
<div class="no-print" x-data="{ 
    activeTab: 'summon',
    selectedProceeding: { 
        type: 'Summon', 
        date: 'N/A', 
        time: 'N/A', 
        day: '[DAY]', 
        month: '[MONTH]', 
        year: '[YEAR]' 
    },
    isScheduleModalOpen: false
}">
    <!-- HEADER: TABS at ang "View All Schedules" BUTTON -->
    <div class="flex flex-col sm:flex-row items-center justify-between mb-4 border-b border-gray-200">
        <nav class="-mb-px flex space-x-1 sm:space-x-4 flex-wrap" aria-label="Tabs">
            <button @click="activeTab = 'summon'" 
                    :class="{ 'border-blue-500 text-blue-600 bg-blue-50': activeTab === 'summon', 'border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-300': activeTab !== 'summon' }" 
                    class="py-3 px-4 font-medium border-b-2 rounded-t-lg transition-colors duration-200 inline-flex items-center">
                <i class="bi bi-file-earmark-text-fill mr-2"></i>Summon
            </button>
            <button @click="activeTab = 'mediation'" 
                    :class="{ 'border-green-500 text-green-600 bg-green-50': activeTab === 'mediation', 'border-transparent text-gray-500 hover:text-green-600 hover:border-green-300': activeTab !== 'mediation' }" 
                    class="py-3 px-4 font-medium border-b-2 rounded-t-lg transition-colors duration-200 inline-flex items-center">
                <i class="bi bi-people-fill mr-2"></i>Mediation
            </button>
            <button @click="activeTab = 'conciliation'" 
                    :class="{ 'border-purple-500 text-purple-600 bg-purple-50': activeTab === 'conciliation', 'border-transparent text-gray-500 hover:text-purple-600 hover:border-purple-300': activeTab !== 'conciliation' }" 
                    class="py-3 px-4 font-medium border-b-2 rounded-t-lg transition-colors duration-200 inline-flex items-center">
                <i class="bi bi-patch-check-fill mr-2"></i>Conciliation
            </button>
        </nav>
        
        <button @click="isScheduleModalOpen = true" class="mt-4 sm:mt-0 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg inline-flex items-center transition-colors">
            <i class="bi bi-calendar3-week-fill mr-2"></i>
            <span>View All Schedules</span>
        </button>
    </div>

    <!-- MAIN CONTENT GRID: Form at Paper -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        
        <!-- LEFT SIDE: Form & Schedule List -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md border">
                <h3 class="font-bold text-xl mb-4">Set a New Schedule</h3>
                <form method="POST" action="{% url 'manage_proceedings' pk=case.pk %}" class="space-y-4">
                    {% csrf_token %}
                    {% for field in form %}
                        <div>
                            <label for="{{ field.id_for_label }}" class="text-sm font-medium text-gray-700">{{ field.label }}</label>
                            <div class="mt-1">{{ field }}</div>
                            {% if field.errors %}<p class="text-xs text-red-500 mt-1">{{ field.errors|striptags }}</p>{% endif %}
                        </div>
                    {% endfor %}
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors">
                        <i class="fas fa-plus-circle mr-2"></i>Add Schedule
                    </button>
                </form>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md border">
                <h3 class="font-bold text-xl mb-4">Scheduled Dates</h3>
                
                <div x-show="activeTab === 'summon'" x-transition>
                    {% for item in summons %}
                        <div class="schedule-item">
                            <span>{{ item.appearance_date|date:"F d, Y" }} at {{ item.appearance_time|time:"g:i A" }}</span>
                            <button @click="selectedProceeding = { type: '{{ item.schedule_type }}', date: '{{ item.appearance_date|date:"F d, Y" }}', time: '{{ item.appearance_time|time:"g:i A" }}', day: '{{ item.appearance_date|date:"d" }}', month: '{{ item.appearance_date|date:"F" }}', year: '{{ item.appearance_date|date:"Y" }}' }" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300">View on Paper</button>
                        </div>
                    {% empty %}<p class="text-sm text-gray-500 text-center py-4">No summons scheduled.</p>{% endfor %}
                </div>
                
                <div x-show="activeTab === 'mediation'" style="display: none;" x-transition>
                    {% for item in mediations %}
                         <div class="schedule-item">
                            <span>{{ item.appearance_date|date:"F d, Y" }} at {{ item.appearance_time|time:"g:i A" }}</span>
                            <button @click="selectedProceeding = { type: '{{ item.schedule_type }}', date: '{{ item.appearance_date|date:"F d, Y" }}', time: '{{ item.appearance_time|time:"g:i A" }}', day: '{{ item.appearance_date|date:"d" }}', month: '{{ item.appearance_date|date:"F" }}', year: '{{ item.appearance_date|date:"Y" }}' }" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300">View on Paper</button>
                        </div>
                    {% empty %}<p class="text-sm text-gray-500 text-center py-4">No mediations scheduled.</p>{% endfor %}
                </div>

                <div x-show="activeTab === 'conciliation'" style="display: none;" x-transition>
                    {% for item in conciliations %}
                         <div class="schedule-item">
                            <span>{{ item.appearance_date|date:"F d, Y" }} at {{ item.appearance_time|time:"g:i A" }}</span>
                            <button @click="selectedProceeding = { type: '{{ item.schedule_type }}', date: '{{ item.appearance_date|date:"F d, Y" }}', time: '{{ item.appearance_time|time:"g:i A" }}', day: '{{ item.appearance_date|date:"d" }}', month: '{{ item.appearance_date|date:"F" }}', year: '{{ item.appearance_date|date:"Y" }}' }" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300">View on Paper</button>
                        </div>
                    {% empty %}<p class="text-sm text-gray-500 text-center py-4">No conciliations scheduled.</p>{% endfor %}
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE: DYNAMIC PAPER -->
        <div class="lg:col-span-3">
    <!-- ======================================================= -->
    <!-- ITO ANG BAGONG PRINT BUTTON SECTION -->
    <!-- ======================================================= -->
    <div class="text-right mb-4 no-print">
        <button onclick="printPaper()" 
                class="inline-flex items-center gap-2 bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md
                       transition-all duration-200 transform hover:scale-105">
            <i class="bi bi-printer-fill"></i>
            <span>Print Document</span>
        </button>
    </div>
            
            <!-- ======================================================= -->
            <!-- ITO ANG KUMLETONG PRINTABLE PAPER -->
            <!-- ======================================================= -->
            <div id="printable-paper" class="bg-white p-8 rounded-lg shadow-md border-2 border-gray-300 font-serif text-sm">
                <!-- Header -->
                <div class="flex justify-between items-center border-b-2 border-black pb-4">
                    <img src="{% static 'images/city_logo.png' %}" alt="Logo" class="img-fluid" style="max-width: 105px;">
                    <div class="text-center">
                        <p class="font-semibold">Republic of the Philippines</p>
                        <p class="font-semibold">City of Mandaluyong</p>
                        <h1 class="text-2xl font-bold">BARANGAY ADDITION HILLS</h1>
                        <p class="font-semibold">OFFICE OF THE LUPONG TAGAPAMAYAPA</p>
                    </div>
                    <img src="{% static 'images/barangay_seal.png' %}" alt="Logo" class="img-fluid" style="max-width: 100px;">
                </div>
                
                <!-- Case Details -->
                <table class="w-full mt-6 text-left">
                    <tr><td class="w-2/3"><p class="font-bold">{{ case.complainant.get_full_name|upper }}</p><p class="border-t border-black mr-4">Complainant/s</p></td><td class="w-1/3" rowspan="2"><p class="font-bold">Case No.</p><p class="border-b border-black text-center">{{ case.blotter_id }}</p><p class="font-bold mt-2">For:</p><p class="border-b border-black text-center">{{ case.get_incident_type_display }}</p></td></tr>
                    <tr><td><p class="font-bold text-center text-lg italic">- against -</p><p class="font-bold">{{ case.respondent_first_name|upper }} {{ case.respondent_last_name|upper }}</p><p class="border-t border-black mr-4">Respondent/s</p></td></tr>
                </table>
                
                <!-- Dynamic Title & Body -->
                <div class="mt-8">
                    <h2 class="text-center text-3xl font-bold my-4 tracking-widest" x-text="selectedProceeding.type.toUpperCase()"></h2>
                    <template x-if="selectedProceeding.type === 'Summon'">
                        <div class="space-y-4 text-justify indent-8">
                            <p><strong>TO:</strong> {{ case.respondent_first_name }} {{ case.respondent_last_name }}<br><span class="ml-4">(Respondent)</span></p>
                            <p>You are hereby summoned to appear before me in person, together with your witnesses, on the <strong class="underline" x-text="selectedProceeding.day"></strong> day of <strong class="underline" x-text="selectedProceeding.month"></strong>, <strong class="underline" x-text="selectedProceeding.year"></strong> at <strong class="underline" x-text="selectedProceeding.time"></strong>, to answer a complaint for mediation/conciliation.</p>
                            <p>You are warned that failure to appear may result in you being barred from filing any counterclaim.</p>
                            <p>This <span class="underline">__</span> day of <span class="underline">________</span>, 20<span class="underline">__</span>.</p>
                        </div>
                    </template>
                    <template x-if="selectedProceeding.type === 'Mediation' || selectedProceeding.type === 'Conciliation'">
                         <div class="space-y-4 text-justify indent-8">
                            <p><strong>TO:</strong> {{ case.complainant.get_full_name }} & {{ case.respondent_first_name }} {{ case.respondent_last_name }}</p>
                            <p>You are hereby required to appear before me on the <strong class="underline" x-text="selectedProceeding.day"></strong> day of <strong class="underline" x-text="selectedProceeding.month"></strong>, <strong class="underline" x-text="selectedProceeding.year"></strong> at <strong class="underline" x-text="selectedProceeding.time"></strong> for the hearing of your case.</p>
                            <p>This <span class="underline">__</span> day of <span class="underline">________</span>, 20<span class="underline">__</span>.</p>
                        </div>
                    </template>
                </div>
                
                <!-- Signature -->
                <footer class="mt-16 text-right"><div class="inline-block text-center"><p class="font-bold border-t border-black px-8">HON. [PUNONG BARANGAY NAME]</p><p>Punong Barangay / Pangkat Chairman</p></div></footer>
             </div>
        </div>
    </div>

    <!-- SCHEDULES MODAL (POP-UP) -->
    <div x-show="isScheduleModalOpen" 
        x-transition.opacity.duration.300ms 
        class="fixed inset-0 z-50 flex items-center justify-center p-4" 
        style="display: none;">

    <!-- Overlay -->
        <div @click="isScheduleModalOpen = false" class="fixed inset-0 modal-overlay"></div>

        <!-- Modal Content -->
        <div x-show="isScheduleModalOpen" 
            x-transition:enter="transition ease-out duration-300" 
            x-transition:enter-start="opacity-0 scale-95" 
            x-transition:enter-end="opacity-100 scale-100" 
            x-transition:leave="transition ease-in duration-200" 
            x-transition:leave-start="opacity-100 scale-100" 
            x-transition:leave-end="opacity-0 scale-95" 
            class="bg-white rounded-lg shadow-xl w-full max-w-4xl overflow-hidden transform" 
            @click.outside="isScheduleModalOpen = false">

            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-xl font-semibold text-gray-800">All Schedules for Case: {{ case.blotter_id }}</h3>
                <button @click="isScheduleModalOpen = false" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">Ã—</button>
            </div>

            <!-- Modal Body with Table -->
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                        </tr>
                    </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        
                        <!-- DITO ANG BAGONG FOR LOOP NA GUMAGAMIT NG 'all_schedules' -->
                        {% for schedule in all_schedules %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if schedule.schedule_type == 'Summon' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Summon</span>
                                {% elif schedule.schedule_type == 'Mediation' %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Mediation</span>
                                {% elif schedule.schedule_type == 'Conciliation' %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Conciliation</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ schedule.appearance_date|date:"F d, Y" }} at {{ schedule.appearance_time|time:"g:i A" }}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">{{ schedule.remarks|default:"--"|truncatewords:10 }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ schedule.created_by.get_full_name|default:"System" }}</td>
                        </tr>
                        {% empty %}
                    <!-- ITO ANG LALABAS KUNG WALANG LAMAN ANG 'all_schedules' -->
                        <tr>
                            <td colspan="4" class="text-center py-6 text-gray-500">No schedules have been set for this case.</td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 bg-gray-50 border-t text-right">
                <button @click="isScheduleModalOpen = false" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts_official %}
<script>
    function printPaper() {
        // Step 1: Kunin ang HTML content ng papel na nakikita sa screen.
        const paperContent = document.getElementById('printable-paper').innerHTML;
        
        // Step 2: Gumawa ng bagong temporaryong window para sa printing.
        const printWindow = window.open('', '_blank', 'height=800,width=850');
        
        // Step 3: Isulat ang necessary HTML structure sa bagong window.
        printWindow.document.write('<!DOCTYPE html><html lang="tl"><head>');
        printWindow.document.write('<title>Print Proceeding Document</title>');
        
        // Isama ang Tailwind CSS para sa styling
        printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
        
        // Magdagdag ng print-specific styles
        printWindow.document.write(`
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap');
                body { 
                    font-family: 'serif'; /* Mas formal para sa papel */
                }
                @page { 
                    size: A4; 
                    margin: 0.75in; 
                }
            </style>
        `);
        
        printWindow.document.write('</head><body>');
        
        // Step 4: Ilagay ang kinopyang content ng papel sa bagong window.
        printWindow.document.write(paperContent);
        
        printWindow.document.write('</body></html>');
        
        // Isara ang document para ma-render ito.
        printWindow.document.close();
        
        // Step 5: Maghintay ng konti para ma-load ang lahat (lalo na ang CSS) bago i-trigger ang print dialog.
        setTimeout(function () {
            printWindow.focus(); // I-focus ang bagong window
            printWindow.print(); // I-trigger ang print
            printWindow.close(); // Isara ang window pagkatapos
        }, 500); // 0.5-second delay
    }
</script>
{% endblock %}